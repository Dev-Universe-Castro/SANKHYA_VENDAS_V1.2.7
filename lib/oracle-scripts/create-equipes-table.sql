-- ============================================================
-- SCRIPT: Criação de tabelas para Gerenciamento de Equipes
-- Autor: Sistema Sankhya Força de Vendas
-- Data: 2026-01-29
-- ============================================================

-- Tabela principal de equipes
CREATE TABLE AD_EQUIPES (
    CODEQUIPE       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_EMPRESA      NUMBER NOT NULL,
    NOME            VARCHAR2(200) NOT NULL,
    DESCRICAO       VARCHAR2(500),
    CODUSUARIO_GESTOR NUMBER,  -- Usuário gestor da equipe (FK para AD_USUARIOSVENDAS)
    ATIVO           CHAR(1) DEFAULT 'S' CHECK (ATIVO IN ('S', 'N')),
    DATA_CRIACAO    DATE DEFAULT SYSDATE,
    DATA_ATUALIZACAO DATE DEFAULT SYSDATE,
    CONSTRAINT UK_EQUIPES_NOME_EMPRESA UNIQUE (ID_EMPRESA, NOME)
);

COMMENT ON TABLE AD_EQUIPES IS 'Tabela de equipes comerciais';
COMMENT ON COLUMN AD_EQUIPES.CODEQUIPE IS 'Código único da equipe';
COMMENT ON COLUMN AD_EQUIPES.ID_EMPRESA IS 'ID da empresa (multi-tenant)';
COMMENT ON COLUMN AD_EQUIPES.NOME IS 'Nome da equipe';
COMMENT ON COLUMN AD_EQUIPES.DESCRICAO IS 'Descrição da equipe';
COMMENT ON COLUMN AD_EQUIPES.CODUSUARIO_GESTOR IS 'Código do usuário gestor da equipe';
COMMENT ON COLUMN AD_EQUIPES.ATIVO IS 'S = Ativo, N = Inativo';

-- Tabela de membros das equipes
CREATE TABLE AD_EQUIPES_MEMBROS (
    CODMEMBRO       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODEQUIPE       NUMBER NOT NULL,
    CODUSUARIO      NUMBER NOT NULL,
    ID_EMPRESA      NUMBER NOT NULL,
    DATA_ENTRADA    DATE DEFAULT SYSDATE,
    ATIVO           CHAR(1) DEFAULT 'S' CHECK (ATIVO IN ('S', 'N')),
    CONSTRAINT FK_EQUIPES_MEMBROS_EQUIPE FOREIGN KEY (CODEQUIPE) REFERENCES AD_EQUIPES(CODEQUIPE),
    CONSTRAINT UK_EQUIPES_MEMBROS UNIQUE (CODEQUIPE, CODUSUARIO)
);

COMMENT ON TABLE AD_EQUIPES_MEMBROS IS 'Membros das equipes comerciais';
COMMENT ON COLUMN AD_EQUIPES_MEMBROS.CODMEMBRO IS 'Código único do membro';
COMMENT ON COLUMN AD_EQUIPES_MEMBROS.CODEQUIPE IS 'Código da equipe';
COMMENT ON COLUMN AD_EQUIPES_MEMBROS.CODUSUARIO IS 'Código do usuário membro';
COMMENT ON COLUMN AD_EQUIPES_MEMBROS.ID_EMPRESA IS 'ID da empresa (multi-tenant)';
COMMENT ON COLUMN AD_EQUIPES_MEMBROS.DATA_ENTRADA IS 'Data de entrada na equipe';
COMMENT ON COLUMN AD_EQUIPES_MEMBROS.ATIVO IS 'S = Ativo, N = Inativo';

-- Índices para performance
CREATE INDEX IDX_EQUIPES_EMPRESA ON AD_EQUIPES(ID_EMPRESA);
CREATE INDEX IDX_EQUIPES_GESTOR ON AD_EQUIPES(CODUSUARIO_GESTOR);
CREATE INDEX IDX_EQUIPES_MEMBROS_EQUIPE ON AD_EQUIPES_MEMBROS(CODEQUIPE);
CREATE INDEX IDX_EQUIPES_MEMBROS_USUARIO ON AD_EQUIPES_MEMBROS(CODUSUARIO);
CREATE INDEX IDX_EQUIPES_MEMBROS_EMPRESA ON AD_EQUIPES_MEMBROS(ID_EMPRESA);

-- Adicionar coluna CODEQUIPE na tabela de usuários (para gestores escolherem equipe)
-- Se a coluna não existir, execute:
-- ALTER TABLE AD_USUARIOSVENDAS ADD CODEQUIPE NUMBER;
-- COMMENT ON COLUMN AD_USUARIOSVENDAS.CODEQUIPE IS 'Código da equipe do gestor';

-- View para consulta facilitada de equipes com membros
CREATE OR REPLACE VIEW VW_EQUIPES_COMPLETA AS
SELECT 
    e.CODEQUIPE,
    e.ID_EMPRESA,
    e.NOME AS NOME_EQUIPE,
    e.DESCRICAO,
    e.CODUSUARIO_GESTOR,
    g.NOME AS NOME_GESTOR,
    e.ATIVO AS EQUIPE_ATIVA,
    e.DATA_CRIACAO,
    m.CODMEMBRO,
    m.CODUSUARIO AS CODUSUARIO_MEMBRO,
    u.NOME AS NOME_MEMBRO,
    u.CODVENDEDOR,
    m.DATA_ENTRADA,
    m.ATIVO AS MEMBRO_ATIVO
FROM AD_EQUIPES e
LEFT JOIN AD_USUARIOSVENDAS g ON e.CODUSUARIO_GESTOR = g.CODUSUARIO
LEFT JOIN AD_EQUIPES_MEMBROS m ON e.CODEQUIPE = m.CODEQUIPE AND m.ATIVO = 'S'
LEFT JOIN AD_USUARIOSVENDAS u ON m.CODUSUARIO = u.CODUSUARIO
WHERE e.ATIVO = 'S';

-- ============================================================
-- EXEMPLOS DE USO:
-- ============================================================
-- Inserir equipe:
-- INSERT INTO AD_EQUIPES (ID_EMPRESA, NOME, DESCRICAO, CODUSUARIO_GESTOR) 
-- VALUES (1, 'Equipe Sul', 'Equipe comercial região Sul', 5);

-- Adicionar membro à equipe:
-- INSERT INTO AD_EQUIPES_MEMBROS (CODEQUIPE, CODUSUARIO, ID_EMPRESA)
-- VALUES (1, 10, 1);

-- Consultar equipes de uma empresa:
-- SELECT * FROM AD_EQUIPES WHERE ID_EMPRESA = 1 AND ATIVO = 'S';

-- Consultar membros de uma equipe:
-- SELECT * FROM VW_EQUIPES_COMPLETA WHERE CODEQUIPE = 1;
