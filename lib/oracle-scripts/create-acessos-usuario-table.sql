-- Script SQL para criação da tabela de Acessos de Usuários
-- Sistema de Controle de Permissões

-- Tabela principal de acessos do usuário
CREATE TABLE AD_ACESSOS_USUARIO (
    CODACESSO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODUSUARIO NUMBER NOT NULL,
    ID_EMPRESA NUMBER DEFAULT 1,
    
    -- Seção 2: Regra de Acesso a Clientes
    -- VINCULADO = Somente clientes vinculados ao usuário
    -- EQUIPE = Somente clientes vinculados à equipe
    -- MANUAL = Selecionar clientes manualmente
    -- TODOS = Todos os clientes
    ACESSO_CLIENTES VARCHAR2(20) DEFAULT 'VINCULADO',
    
    -- Seção 3: Regra de Acesso a Produtos
    -- TODOS = Todos os produtos
    -- MARCA = Produtos por marca
    -- GRUPO = Produtos por grupo de produtos
    -- MANUAL = Selecionar produtos manualmente
    ACESSO_PRODUTOS VARCHAR2(20) DEFAULT 'TODOS',
    
    -- Seção 6: Regra de Acesso a Tarefas
    -- VINCULADO = Somente tarefas vinculadas ao usuário
    -- EQUIPE = Somente tarefas vinculadas à equipe
    -- TODOS = Todas as tarefas
    ACESSO_TAREFAS VARCHAR2(20) DEFAULT 'VINCULADO',
    
    -- Seção 7: Administração
    ACESSO_ADMINISTRACAO CHAR(1) DEFAULT 'N', -- S/N
    ACESSO_USUARIOS CHAR(1) DEFAULT 'N', -- S/N
    
    -- Seção 9: Acesso às Telas
    TELA_PEDIDOS_VENDAS CHAR(1) DEFAULT 'S', -- S/N
    TELA_ROTAS CHAR(1) DEFAULT 'S', -- S/N
    TELA_TAREFAS CHAR(1) DEFAULT 'S', -- S/N
    TELA_NEGOCIOS CHAR(1) DEFAULT 'S', -- S/N
    TELA_CLIENTES CHAR(1) DEFAULT 'S', -- S/N
    TELA_PRODUTOS CHAR(1) DEFAULT 'S', -- S/N
    TELA_TABELA_PRECOS CHAR(1) DEFAULT 'S', -- S/N
    TELA_USUARIOS CHAR(1) DEFAULT 'N', -- S/N
    TELA_ADMINISTRACAO CHAR(1) DEFAULT 'N', -- S/N
    
    -- Controle
    DTALTERACAO DATE DEFAULT SYSDATE,
    
    CONSTRAINT FK_ACESSO_USUARIO FOREIGN KEY (CODUSUARIO) 
        REFERENCES AD_USUARIOSVENDAS(CODUSUARIO)
);

-- Tabela para seleção manual de clientes (quando ACESSO_CLIENTES = 'MANUAL')
CREATE TABLE AD_ACESSOS_CLIENTES_MANUAL (
    CODACESSOCLIENTE NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODUSUARIO NUMBER NOT NULL,
    CODPARC NUMBER NOT NULL,
    ID_EMPRESA NUMBER DEFAULT 1,
    DTINCLUSAO DATE DEFAULT SYSDATE,
    
    CONSTRAINT FK_ACESSO_CLI_USUARIO FOREIGN KEY (CODUSUARIO) 
        REFERENCES AD_USUARIOSVENDAS(CODUSUARIO),
    CONSTRAINT UK_ACESSO_CLIENTE UNIQUE (CODUSUARIO, CODPARC)
);

-- Tabela para seleção manual de produtos (quando ACESSO_PRODUTOS = 'MANUAL')
CREATE TABLE AD_ACESSOS_PRODUTOS_MANUAL (
    CODACESSOPRODUTO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODUSUARIO NUMBER NOT NULL,
    CODPROD NUMBER NOT NULL,
    ID_EMPRESA NUMBER DEFAULT 1,
    DTINCLUSAO DATE DEFAULT SYSDATE,
    
    CONSTRAINT FK_ACESSO_PROD_USUARIO FOREIGN KEY (CODUSUARIO) 
        REFERENCES AD_USUARIOSVENDAS(CODUSUARIO),
    CONSTRAINT UK_ACESSO_PRODUTO UNIQUE (CODUSUARIO, CODPROD)
);

-- Tabela para seleção de marcas (quando ACESSO_PRODUTOS = 'MARCA')
CREATE TABLE AD_ACESSOS_MARCAS (
    CODACESSOMARCA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODUSUARIO NUMBER NOT NULL,
    CODMARCA NUMBER NOT NULL,
    ID_EMPRESA NUMBER DEFAULT 1,
    DTINCLUSAO DATE DEFAULT SYSDATE,
    
    CONSTRAINT FK_ACESSO_MARCA_USUARIO FOREIGN KEY (CODUSUARIO) 
        REFERENCES AD_USUARIOSVENDAS(CODUSUARIO),
    CONSTRAINT UK_ACESSO_MARCA UNIQUE (CODUSUARIO, CODMARCA)
);

-- Tabela para seleção de grupos de produtos (quando ACESSO_PRODUTOS = 'GRUPO')
CREATE TABLE AD_ACESSOS_GRUPOS (
    CODACESSOGRUPO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CODUSUARIO NUMBER NOT NULL,
    CODGRUPOPROD NUMBER NOT NULL,
    ID_EMPRESA NUMBER DEFAULT 1,
    DTINCLUSAO DATE DEFAULT SYSDATE,
    
    CONSTRAINT FK_ACESSO_GRUPO_USUARIO FOREIGN KEY (CODUSUARIO) 
        REFERENCES AD_USUARIOSVENDAS(CODUSUARIO),
    CONSTRAINT UK_ACESSO_GRUPO UNIQUE (CODUSUARIO, CODGRUPOPROD)
);

-- Índices para melhor performance
CREATE INDEX IDX_ACESSOS_USUARIO ON AD_ACESSOS_USUARIO(CODUSUARIO);
CREATE INDEX IDX_ACESSOS_CLIENTES ON AD_ACESSOS_CLIENTES_MANUAL(CODUSUARIO);
CREATE INDEX IDX_ACESSOS_PRODUTOS ON AD_ACESSOS_PRODUTOS_MANUAL(CODUSUARIO);
CREATE INDEX IDX_ACESSOS_MARCAS ON AD_ACESSOS_MARCAS(CODUSUARIO);
CREATE INDEX IDX_ACESSOS_GRUPOS ON AD_ACESSOS_GRUPOS(CODUSUARIO);

-- Comentários nas colunas
COMMENT ON TABLE AD_ACESSOS_USUARIO IS 'Tabela de configuração de acessos por usuário';
COMMENT ON COLUMN AD_ACESSOS_USUARIO.ACESSO_CLIENTES IS 'VINCULADO|EQUIPE|MANUAL|TODOS - Define regra de acesso a clientes';
COMMENT ON COLUMN AD_ACESSOS_USUARIO.ACESSO_PRODUTOS IS 'TODOS|MARCA|GRUPO|MANUAL - Define regra de acesso a produtos';
COMMENT ON COLUMN AD_ACESSOS_USUARIO.ACESSO_TAREFAS IS 'VINCULADO|EQUIPE|TODOS - Define regra de acesso a tarefas';

-- Inserir registro padrão para usuários existentes (opcional)
-- INSERT INTO AD_ACESSOS_USUARIO (CODUSUARIO)
-- SELECT CODUSUARIO FROM AD_USUARIOSVENDAS WHERE CODUSUARIO NOT IN (SELECT CODUSUARIO FROM AD_ACESSOS_USUARIO);

COMMIT;
